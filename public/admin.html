<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarpahVip Key System - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <header>
            <h1>üîê WarpahVip Key System</h1>
            <p>Admin Management Panel</p>
        </header>

        <div class="login-section" id="loginSection">
            <input type="password" id="passwordInput" placeholder="Enter admin password...">
            <button onclick="login()" id="loginBtn">Login</button>
        </div>

        <div class="main-panel" id="mainPanel" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Keys</h3>
                    <span id="totalKeys">0</span>
                </div>
                <div class="stat-card">
                    <h3>Active Keys</h3>
                    <span id="activeKeys">0</span>
                </div>
            </div>

            <div class="actions">
                <div class="action-group">
                    <h3>Generate Keys</h3>
                    <input type="number" id="keyCount" value="1" min="1" max="100">
                    <select id="keyDuration">
                        <option value="1d">1 Day</option>
                        <option value="7d">7 Days</option>
                        <option value="30d" selected>30 Days</option>
                        <option value="90d">90 Days</option>
                        <option value="365d">1 Year</option>
                    </select>
                    <button onclick="generateKeys()">Generate</button>
                </div>
            </div>

            <div class="keys-section">
                <h3>Key Management</h3>
                <button onclick="refreshKeys()">üîÑ Refresh</button>
                <div class="keys-list" id="keysList"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let adminPassword = '';

        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) return;

            try {
                const response = await fetch(`${API_BASE}/admin?password=${password}`);
                if (response.ok) {
                    adminPassword = password;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('mainPanel').style.display = 'block';
                    loadDashboard();
                } else {
                    alert('Invalid password!');
                }
            } catch (error) {
                alert('Connection error!');
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin?password=${adminPassword}`);
                const data = await response.json();
                
                document.getElementById('totalKeys').textContent = data.total;
                document.getElementById('activeKeys').textContent = data.active;
                
                displayKeys(data.keys);
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function generateKeys() {
            const count = parseInt(document.getElementById('keyCount').value);
            const duration = document.getElementById('keyDuration').value;

            try {
                const response = await fetch(`${API_BASE}/create-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        count: count,
                        duration: duration
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`Generated ${data.count} keys successfully!`);
                    loadDashboard();
                }
            } catch (error) {
                alert('Failed to generate keys!');
            }
        }

        async function resetKey(key) {
            if (!confirm('Reset device binding for this key?')) return;

            try {
                const response = await fetch(`${API_BASE}/reset-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        key: key,
                        action: 'reset'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Key reset successfully!');
                    loadDashboard();
                }
            } catch (error) {
                alert('Failed to reset key!');
            }
        }

        async function deleteKey(key) {
            if (!confirm('Delete this key permanently?')) return;

            try {
                const response = await fetch(`${API_BASE}/reset-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        key: key,
                        action: 'delete'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Key deleted successfully!');
                    loadDashboard();
                }
            } catch (error) {
                alert('Failed to delete key!');
            }
        }

        function displayKeys(keys) {
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = '';

            keys.forEach(keyData => {
                const keyElement = document.createElement('div');
                keyElement.className = 'key-item';
                
                const isExpired = Date.now() > keyData.expires;
                const status = !keyData.active ? 'inactive' : isExpired ? 'expired' : 'active';
                
                keyElement.innerHTML = `
                    <div class="key-info">
                        <strong>${keyData.key}</strong>
                        <span class="status ${status}">${status.toUpperCase()}</span>
                    </div>
                    <div class="key-details">
                        <small>Device: ${keyData.device_id ? 'Bound' : 'Unbound'}</small>
                        <small>Used: ${keyData.usage_count} times</small>
                        <small>Expires: ${new Date(keyData.expires).toLocaleDateString()}</small>
                    </div>
                    <div class="key-actions">
                        <button onclick="navigator.clipboard.writeText('${keyData.key}')">Copy</button>
                        <button onclick="resetKey('${keyData.key}')">Reset</button>
                        <button onclick="deleteKey('${keyData.key}')" class="danger">Delete</button>
                    </div>
                `;
                
                keysList.appendChild(keyElement);
            });
        }

        function refreshKeys() {
            loadDashboard();
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (adminPassword) {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>
